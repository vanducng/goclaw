package pg

import (
	"fmt"

	"github.com/nextlevelbuilder/goclaw/internal/store"
)

// NewPGStores creates all stores backed by Postgres (managed mode).
func NewPGStores(cfg store.StoreConfig) (*store.Stores, error) {
	db, err := OpenDB(cfg.PostgresDSN)
	if err != nil {
		return nil, fmt.Errorf("open postgres: %w", err)
	}

	memCfg := DefaultPGMemoryConfig()

	skillsDir := cfg.SkillsStorageDir
	if skillsDir == "" {
		skillsDir = "~/.goclaw/skills-store"
	}

	return &store.Stores{
		Sessions:  NewPGSessionStore(db),
		Memory:    NewPGMemoryStore(db, memCfg),
		Cron:      NewPGCronStore(db),
		Pairing:   NewPGPairingStore(db),
		Skills:    NewPGSkillStore(db, skillsDir),
		Agents:    NewPGAgentStore(db),
		Providers: NewPGProviderStore(db, cfg.EncryptionKey),
		Tracing:   NewPGTracingStore(db),
		MCP:              NewPGMCPServerStore(db, cfg.EncryptionKey),
		CustomTools:      NewPGCustomToolStore(db, cfg.EncryptionKey),
		ChannelInstances: NewPGChannelInstanceStore(db, cfg.EncryptionKey),
		ConfigSecrets:    NewPGConfigSecretsStore(db, cfg.EncryptionKey),
		AgentLinks:       NewPGAgentLinkStore(db),
		Teams:            NewPGTeamStore(db),
		BuiltinTools:     NewPGBuiltinToolStore(db),
	}, nil
}
